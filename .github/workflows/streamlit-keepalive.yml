name: streamlit-keepalive

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    env:
      APP_URL: "https://nursecall-demo.streamlit.app/"

    steps:
      - name: Decide wake strategy (HTML + health + hourly forced browser)
        id: precheck
        run: |
          set -euo pipefail

          APP="${APP_URL%/}"
          ROOT="${APP}/?ping=$(date +%s)"
          HEALTH="${APP}/_stcore/health"

          rm -f /tmp/cookies.txt /tmp/root.html /tmp/root_headers.txt /tmp/health_headers.txt
          echo "ROOT:   $ROOT"
          echo "HEALTH: $HEALTH"

          # ---- 1) Fetch root HTML (cookie-aware) ----
          root_meta="$(curl -sS -L --max-redirs 20 \
            --retry 3 --retry-all-errors \
            --connect-timeout 10 --max-time 45 \
            --compressed \
            -A "Mozilla/5.0 (compatible; GitHubActionsPing/1.0)" \
            -c /tmp/cookies.txt -b /tmp/cookies.txt \
            -D /tmp/root_headers.txt \
            -o /tmp/root.html \
            -w "ROOT_HTTP=%{http_code} ROOT_FINAL=%{url_effective}\n" \
            "$ROOT" || true)"
          echo "$root_meta"
          root_code="$(echo "$root_meta" | sed -n 's/.*ROOT_HTTP=\([0-9]\{3\}\).*/\1/p' | tail -n 1)"

          # ---- 2) Health check ----
          health_code="$(curl -sS -L --max-redirs 10 \
            --retry 2 --retry-all-errors \
            --connect-timeout 10 --max-time 20 \
            -A "Mozilla/5.0 (compatible; GitHubActionsHealth/1.0)" \
            -c /tmp/cookies.txt -b /tmp/cookies.txt \
            -D /tmp/health_headers.txt \
            -o /dev/null \
            -w "%{http_code}" \
            "$HEALTH" || true)"
          echo "HEALTH_HTTP=$health_code"

          wake_needed="false"

          # Strong sleep detection (matches your Zzzz page)
          if [ -f /tmp/root.html ] && grep -Eqi "Zzzz|gone to sleep|inactivity|get this app back up" /tmp/root.html; then
            wake_needed="true"
          fi
          if [ "${health_code:-}" != "200" ]; then
            wake_needed="true"
          fi
          if [ "${root_code:-}" != "200" ]; then
            wake_needed="true"
          fi

          # ---- 3) Hourly forced browser session ----
          # Since we run every 10 min, every 6th run = ~1 hour.
          # Use GitHub run_number to decide.
          rn="${{ github.run_number }}"
          force_browser="false"
          if [ $((rn % 6)) -eq 0 ]; then
            force_browser="true"
          fi

          echo "wake_needed=$wake_needed"
          echo "force_browser=$force_browser"
          echo "root_code=${root_code:-}"
          echo "health_code=${health_code:-}"

          echo "wake_needed=${wake_needed}" | tee -a "$GITHUB_OUTPUT"
          echo "force_browser=${force_browser}" | tee -a "$GITHUB_OUTPUT"
          echo "root_code=${root_code:-}" | tee -a "$GITHUB_OUTPUT"
          echo "health_code=${health_code:-}" | tee -a "$GITHUB_OUTPUT"

      - name: Setup Node.js (only if wake_needed OR force_browser)
        if: steps.precheck.outputs.wake_needed == 'true' || steps.precheck.outputs.force_browser == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Playwright (only if wake_needed OR force_browser)
        if: steps.precheck.outputs.wake_needed == 'true' || steps.precheck.outputs.force_browser == 'true'
        run: |
          set -euo pipefail
          npm init -y >/dev/null 2>&1
          npm i playwright >/dev/null
          npx playwright install --with-deps chromium

      - name: Browser keepalive (click if sleeping; otherwise just load)
        if: steps.precheck.outputs.wake_needed == 'true' || steps.precheck.outputs.force_browser == 'true'
        env:
          APP_URL: ${{ env.APP_URL }}
          WAKE_NEEDED: ${{ steps.precheck.outputs.wake_needed }}
          FORCE_BROWSER: ${{ steps.precheck.outputs.force_browser }}
        run: |
          set -euo pipefail
          node - <<'NODE'
          const { chromium } = require('playwright');

          (async () => {
            const app = process.env.APP_URL.replace(/\/+$/, '');
            const wakeNeeded = process.env.WAKE_NEEDED === 'true';
            const forceBrowser = process.env.FORCE_BROWSER === 'true';

            const url = `${app}/?ping=${Date.now()}`;
            console.log("Open:", url);
            console.log("wakeNeeded:", wakeNeeded, "forceBrowser:", forceBrowser);

            const browser = await chromium.launch();
            const page = await browser.newPage({
              userAgent: 'Mozilla/5.0 (compatible; GitHubActionsPlaywright/1.0)'
            });

            await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 });

            // Only click when we think it's sleeping (or if the button is present anyway)
            const exact = page.getByRole('button', { name: 'Yes, get this app back up!' });
            const fallback = page.getByRole('button', { name: /get this app back up|wake up/i });

            let clicked = false;
            if (await exact.count()) {
              console.log("Wake button found (exact). Clicking...");
              await exact.first().click({ timeout: 5000 });
              clicked = true;
            } else if (await fallback.count()) {
              console.log("Wake button found (fallback). Clicking...");
              await fallback.first().click({ timeout: 5000 });
              clicked = true;
            } else {
              console.log("No wake button visible.");
            }

            // If we clicked, wait longer for cold start; otherwise short wait is enough
            if (clicked) {
              await page.waitForTimeout(25000);
            } else {
              await page.waitForTimeout(6000);
            }

            // Best-effort: detect Streamlit container
            try {
              await page.waitForSelector('div[data-testid="stAppViewContainer"]', { timeout: 30000 });
              console.log("Streamlit container detected.");
            } catch {
              console.log("Streamlit container not detected (may still be fine).");
            }

            console.log("Final URL:", page.url());
            await browser.close();
          })().catch(err => {
            console.error(err);
            process.exit(1);
          });
          NODE

      - name: Final check (health must be 200; root must not be sleeping)
        run: |
          set -euo pipefail
          APP="${APP_URL%/}"
          ROOT="${APP}/?ping=$(date +%s)"
          HEALTH="${APP}/_stcore/health"

          rm -f /tmp/final_cookies.txt /tmp/final_root.html /tmp/final_root_headers.txt /tmp/final_health_headers.txt

          ok="false"
          for i in 1 2 3 4 5; do
            code="$(curl -sS -L --max-redirs 10 \
              --connect-timeout 10 --max-time 20 \
              -A "Mozilla/5.0 (compatible; GitHubActionsFinalHealth/1.0)" \
              -c /tmp/final_cookies.txt -b /tmp/final_cookies.txt \
              -D /tmp/final_health_headers.txt \
              -o /dev/null \
              -w "%{http_code}" \
              "$HEALTH" || true)"
            echo "Attempt $i: HEALTH_HTTP=$code"
            if [ "$code" = "200" ]; then
              ok="true"
              break
            fi
            sleep 6
          done

          if [ "$ok" != "true" ]; then
            echo "ERROR: health endpoint never returned 200"
            tail -n 80 /tmp/final_health_headers.txt || true
            exit 1
          fi

          curl -sS -L --max-redirs 20 \
            --connect-timeout 10 --max-time 45 \
            --compressed \
            -A "Mozilla/5.0 (compatible; GitHubActionsFinalRoot/1.0)" \
            -c /tmp/final_cookies.txt -b /tmp/final_cookies.txt \
            -D /tmp/final_root_headers.txt \
            -o /tmp/final_root.html \
            "$ROOT"

          if grep -Eqi "Zzzz|gone to sleep|inactivity|get this app back up" /tmp/final_root.html; then
            echo "ERROR: still sleeping page after keepalive"
            exit 1
          fi

          echo "OK: app is awake."

      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: streamlit-keepalive-debug
          path: |
            /tmp/root.html
            /tmp/root_headers.txt
            /tmp/health_headers.txt
            /tmp/final_root.html
            /tmp/final_root_headers.txt
            /tmp/final_health_headers.txt

