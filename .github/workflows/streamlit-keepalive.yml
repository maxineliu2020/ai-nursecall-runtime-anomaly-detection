name: streamlit-keepalive

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest

    env:
      APP_URL: "https://nursecall-demo.streamlit.app/"

    steps:
      - name: Pre-check with curl (cookie-aware)
        id: precheck
        run: |
          set -euo pipefail

          URL="${APP_URL}?ping=$(date +%s)"
          echo "Precheck URL: $URL"

          rm -f /tmp/cookies.txt /tmp/resp.html /tmp/headers.txt

          # 一次请求拿到：body + headers + http_code + final_url
          meta="$(curl -sS -L --max-redirs 20 \
            --retry 3 --retry-all-errors \
            --connect-timeout 10 --max-time 45 \
            --compressed \
            -A "Mozilla/5.0 (compatible; GitHubActionsPing/1.0)" \
            -c /tmp/cookies.txt -b /tmp/cookies.txt \
            -D /tmp/headers.txt \
            -o /tmp/resp.html \
            -w "HTTP=%{http_code} FINAL=%{url_effective}\n" \
            "$URL" || true)"

          echo "$meta"

          http_code="$(echo "$meta" | sed -n 's/.*HTTP=\([0-9][0-9][0-9]\).*/\1/p' | tail -n 1)"
          final_url="$(echo "$meta" | sed -n 's/.*FINAL=\(.*\)$/\1/p' | tail -n 1)"

          wake_needed="false"

          # 非 200 大概率不是正常 app 页面
          if [ "${http_code:-}" != "200" ]; then
            wake_needed="true"
          fi

          # 命中常见“休眠页/唤醒”文案（不同版本略有差异）
          if [ -f /tmp/resp.html ] && grep -Eqi "gone to sleep|get this app back up|wake up|is sleeping" /tmp/resp.html; then
            wake_needed="true"
          fi

          echo "http_code=${http_code:-}" | tee -a "$GITHUB_OUTPUT"
          echo "final_url=${final_url:-}" | tee -a "$GITHUB_OUTPUT"
          echo "wake_needed=${wake_needed}" | tee -a "$GITHUB_OUTPUT"

          echo "wake_needed=${wake_needed}"

      - name: Setup Node.js (only if wake needed)
        if: steps.precheck.outputs.wake_needed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Playwright (only if wake needed)
        if: steps.precheck.outputs.wake_needed == 'true'
        run: |
          set -euo pipefail
          npm init -y >/dev/null 2>&1
          npm i playwright >/dev/null
          npx playwright install --with-deps chromium

      - name: Wake Streamlit by clicking button (only if wake needed)
        if: steps.precheck.outputs.wake_needed == 'true'
        env:
          APP_URL: ${{ env.APP_URL }}
        run: |
          set -euo pipefail
          node - <<'NODE'
          const { chromium } = require('playwright');

          (async () => {
            const base = process.env.APP_URL;
            const url = `${base}?ping=${Date.now()}`;

            const browser = await chromium.launch();
            const page = await browser.newPage({
              userAgent: 'Mozilla/5.0 (compatible; GitHubActionsPlaywright/1.0)'
            });

            console.log('Open:', url);
            await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 });

            // 更聚焦一些，但仍保留兜底
            const candidates = [
              /get this app back up/i,
              /wake up/i,
              /start/i,
              /resume/i,
              /yes/i
            ];

            let clicked = false;
            for (const re of candidates) {
              const btn = page.getByRole('button', { name: re });
              if (await btn.count()) {
                console.log('Click button matching:', re.toString());
                await btn.first().click({ timeout: 5000 });
                clicked = true;
                break;
              }
            }
            console.log('Clicked:', clicked);

            // 给冷启动更充足时间（Streamlit 冷启动经常 >10s）
            await page.waitForTimeout(25000);

            console.log('After-wake URL:', page.url());
            await browser.close();
          })().catch(err => {
            console.error('Playwright error:', err);
            process.exit(1);
          });
          NODE

      - name: Final check with curl (cookie-aware, must be awake)
        run: |
          set -euo pipefail

          URL="${APP_URL}?ping=$(date +%s)"
          echo "Final check URL: $URL"

          rm -f /tmp/final.html /tmp/final_headers.txt

          # 关键：仍然启用 cookie engine，避免 curl 重定向循环
          meta="$(curl -sS -L --max-redirs 20 \
            --retry 3 --retry-all-errors \
            --connect-timeout 10 --max-time 60 \
            --compressed \
            -A "Mozilla/5.0 (compatible; GitHubActionsFinalCheck/1.0)" \
            -c /tmp/cookies.txt -b /tmp/cookies.txt \
            -D /tmp/final_headers.txt \
            -o /tmp/final.html \
            -w "HTTP=%{http_code} FINAL=%{url_effective}\n" \
            "$URL")"

          echo "$meta"

          http_code="$(echo "$meta" | sed -n 's/.*HTTP=\([0-9][0-9][0-9]\).*/\1/p' | tail -n 1)"

          if [ "${http_code:-}" != "200" ]; then
            echo "ERROR: Final check HTTP != 200"
            echo "---- last response headers ----"
            tail -n 60 /tmp/final_headers.txt || true
            exit 1
          fi

          if grep -Eqi "gone to sleep|get this app back up|wake up|is sleeping" /tmp/final.html; then
            echo "ERROR: Still looks like sleeping page after wake attempt."
            echo "---- last response headers ----"
            tail -n 60 /tmp/final_headers.txt || true
            exit 1
          fi

          echo "OK: App appears awake."
